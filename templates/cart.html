{% extends "base.html" %}

{% block title %}Корзина - AutoPoizon{% endblock %}

{% block content %}
<div class="container">
    <div class="breadcrumbs">
        <a href="{{ url_for('index') }}">Главная</a>
        <span class="separator">></span>
        <span>Корзина</span>
    </div>
    
    <h1 class="page-title">Корзина покупок</h1>
    
    {% if cart_items %}
    <div class="cart-container">
        <div class="cart-header">
            <div class="cart-select-all">
                <input type="checkbox" id="select-all" class="cart-checkbox">
                <label for="select-all">Выбрать все</label>
            </div>
            <button class="btn btn-secondary btn-sm" id="remove-selected">
                <i class="fas fa-trash"></i>
                Удалить выбранное
            </button>
        </div>
        
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="cart-item" data-item-id="{{ item.id }}">
                <div class="cart-item-select">
                    <input type="checkbox" class="cart-checkbox item-checkbox" data-item-id="{{ item.id }}">
                </div>
                
                <div class="cart-item-image">
                    <img src="{{ url_for('static', filename='images/parts/' + item.image) }}" 
                         alt="{{ item.name }}" 
                         onerror="this.src='https://via.placeholder.com/100x100?text=Запчасть'">
                </div>
                
                <div class="cart-item-info">
                    <h4 class="cart-item-name">{{ item.name }}</h4>
                    <p class="cart-item-brand">{{ item.brand }} {{ item.model }}</p>
                    <p class="cart-item-number">Артикул: {{ item.part_number }}</p>
                    <button class="btn-remove-item" data-item-id="{{ item.id }}">
                        <i class="fas fa-times"></i>
                        Удалить
                    </button>
                </div>
                
                <div class="cart-item-quantity">
                    <button class="quantity-btn minus" data-item-id="{{ item.id }}">-</button>
                    <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" max="99" 
                           data-item-id="{{ item.id }}">
                    <button class="quantity-btn plus" data-item-id="{{ item.id }}">+</button>
                </div>
                
                <div class="cart-item-price">
                    <span class="price">{{ item.price|int }} руб.</span>
                    <span class="total">{{ (item.price * item.quantity)|int }} руб.</span>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="cart-summary">
            <div class="summary-card">
                <h3>Итого</h3>
                
                <div class="summary-row">
                    <span>Товары ({{ cart_items|length }}):</span>
                    <span>{{ total }} руб.</span>
                </div>
                
                <div class="summary-row">
                    <span>Доставка:</span>
                    <span class="free-shipping">Бесплатно</span>
                </div>
                
                <div class="summary-row discount">
                    <span>Скидка:</span>
                    <span>-{{ (total * 0.05)|int }} руб.</span>
                </div>
                
                <div class="summary-divider"></div>
                
                <div class="summary-row total-row">
                    <span>К оплате:</span>
                    <span class="final-price">{{ (total * 0.95)|int }} руб.</span>
                </div>
                
                <button class="btn btn-primary btn-checkout" id="checkout-btn">
                    <i class="fas fa-shopping-bag"></i>
                    Перейти к оформлению
                </button>
                
                <div class="security-notice">
                    <i class="fas fa-shield-alt"></i>
                    <span>Безопасная оплата • Гарантия возврата</span>
                </div>
            </div>
        </div>
        
        <div class="cart-recommendations">
            <h3>Рекомендуемые товары</h3>
            <div class="recommended-items">
                <div class="recommended-item">
                    <img src="https://via.placeholder.com/80x80?text=Фильтр" alt="Масляный фильтр">
                    <p>Масляный фильтр</p>
                    <span>1 200 руб.</span>
                    <button class="btn btn-sm">Добавить</button>
                </div>
                <div class="recommended-item">
                    <img src="https://via.placeholder.com/80x80?text=Свечи" alt="Свечи зажигания">
                    <p>Свечи зажигания</p>
                    <span>2 800 руб.</span>
                    <button class="btn btn-sm">Добавить</button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <div class="empty-cart-icon">
            <i class="fas fa-shopping-cart"></i>
        </div>
        <h2>Корзина пуста</h2>
        <p>Добавьте товары в корзину, чтобы сделать заказ</p>
        <a href="{{ url_for('catalog') }}" class="btn btn-primary">
            <i class="fas fa-shopping-bag"></i>
            Перейти в каталог
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}




{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Выбор всех товаров
        const selectAll = document.getElementById('select-all');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        
        selectAll.addEventListener('change', function() {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });
        
        // Удаление выбранных товаров
        const removeSelectedBtn = document.getElementById('remove-selected');
        
        removeSelectedBtn.addEventListener('click', function() {
            const selectedItems = Array.from(itemCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.getAttribute('data-item-id'));
            
            if (selectedItems.length > 0) {
                if (confirm('Удалить выбранные товары из корзины?')) {
                    // Здесь будет AJAX-запрос для удаления
                    selectedItems.forEach(itemId => {
                        const itemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                        if (itemElement) {
                            itemElement.style.opacity = '0';
                            setTimeout(() => itemElement.remove(), 300);
                        }
                    });
                    updateCartTotal();
                }
            } else {
                alert('Выберите товары для удаления');
            }
        });
        
        // Удаление отдельного товара
        const removeItemBtns = document.querySelectorAll('.btn-remove-item');
        
        removeItemBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                const itemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                
                if (confirm('Удалить товар из корзины?')) {
                    itemElement.style.opacity = '0';
                    setTimeout(() => itemElement.remove(), 300);
                    updateCartTotal();
                }
            });
        });
        
        // Изменение количества
        const quantityBtns = document.querySelectorAll('.quantity-btn');
        const quantityInputs = document.querySelectorAll('.quantity-input');
        
        quantityBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.getAttribute('data-item-id');
                const input = document.querySelector(`.quantity-input[data-item-id="${itemId}"]`);
                let quantity = parseInt(input.value);
                
                if (this.classList.contains('plus')) {
                    quantity = Math.min(quantity + 1, 99);
                } else if (this.classList.contains('minus')) {
                    quantity = Math.max(quantity - 1, 1);
                }
                
                input.value = quantity;
                updateItemTotal(itemId, quantity);
                updateCartTotal();
            });
        });
        
        quantityInputs.forEach(input => {
            input.addEventListener('change', function() {
                const itemId = this.getAttribute('data-item-id');
                let quantity = parseInt(this.value);
                
                if (isNaN(quantity) || quantity < 1) {
                    quantity = 1;
                    this.value = 1;
                } else if (quantity > 99) {
                    quantity = 99;
                    this.value = 99;
                }
                
                updateItemTotal(itemId, quantity);
                updateCartTotal();
            });
        });
        
        // Обновление итоговой суммы для товара
        function updateItemTotal(itemId, quantity) {
            const itemElement = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
            const price = parseFloat(itemElement.querySelector('.price').textContent);
            const totalElement = itemElement.querySelector('.total');
            
            totalElement.textContent = (price * quantity).toLocaleString() + ' руб.';
        }
        
        // Обновление общей суммы корзины
        function updateCartTotal() {
            // Здесь будет логика пересчета общей суммы
            console.log('Корзина обновлена');
        }
        
        // Оформление заказа
        const checkoutBtn = document.getElementById('checkout-btn');
        
        checkoutBtn.addEventListener('click', function() {
            const selectedItems = Array.from(itemCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.getAttribute('data-item-id'));
            
            if (selectedItems.length > 0) {
                // Переход к оформлению заказа
                window.location.href = "{{ url_for('checkout') }}";
            } else {
                alert('Выберите товары для оформления заказа');
            }
        });
    });
</script>
{% endblock %}